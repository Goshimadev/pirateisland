Content-Type: text/html

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Pirate Island</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- Styles for Fields and Finds -->
    <link rel="stylesheet" href="https://www.geos.ed.ac.uk/~s1788971/piratestylesheet.css">
    <link rel="stylesheet" href="https://www.geos.ed.ac.uk/~s1783947/webmapping/pagestyles.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Enable Mobile Support -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>

    .form-steps{
      height: 40px;
      margin-right: 2px;
      background-color: #cceeff;
      padding-left: 5px;
      box-sizing: border-box;
      border: none;
      font-size: 16px;
      width: 40px;
    }

    .form-steps:focus{
      background-color: lightsteelblue;
    }

    .form-dir{
      height: 40px;
      margin-left: 5px;
      margin-right: 0px;
      background-color: #cceeff;
      box-sizing: border-box;
      border: none;
      font-size: 16px;
    }

    .form-dir:focus{
      background-color: lightsteelblue;
    }

    .btn-default{
      height: 40px;
      border-radius: 0px;
      background-color: #fbf3d4;
      border: none;
      font-size: 16px;
    }

    .btn-default:hover,
    .btn-default:focus{
      background-color: lightsteelblue;

    }

    .round {
      border-radius: 50%;
      height: 30px;
      margin-left: 10px;
    }

    </style>

  </head>

  <body>
 <!-- Background Music -->
  <audio id="pirateAudio" autoplay="autoplay">
      <source src="https://www.geos.ed.ac.uk/~s1790173/music/he_is_a_pirate.mp3" type="audio/mp3">
  </audio>

  <!-- SVG Patterns -->
  <svg width=0 height=0>
  <defs>
	<pattern id="wavepattern" class="wavepattern" x="0" y="0" width="2" height="0.8" patternUnits="userSpaceOnUse" viewBox="-1164 653.8 806.1 95.3">
      <path d="M-1164,667.9c36.2,52.5,83.8,81.3,134.4,81.3c50.5,0,98.1-28.8,134.4-81.3c36.2,52.5,83.8,81.3,134.4,81.3 c50.5,0,98.1-28.8,134.4-81.3c36.2,52.5,83.8,81.3,134.4,81.3s98.1-28.8,134.4-81.3v-14l-2.3,3.5c-35.3,52.8-82.1,81.8-132,81.8 s-96.7-29.1-132-81.8l-2.3-3.5l-2.3,3.5c-35.3,52.8-82.1,81.8-132,81.8c-49.9,0-96.7-29.1-132-81.8l-2.3-3.5l-2.3,3.5 c-35.3,52.8-82.1,81.8-132,81.8c-49.9,0-96.7-29.1-132-81.8l-2.3-3.5L-1164,667.9L-1164,667.9z"/>
	</pattern>
	<pattern id="sandpattern" x="0" y="0" width="0.2" height="0.2" patternUnits="userSpaceOnUse" viewBox="0 0 10 10">
      <rect class="islandbackground" id="1" x="0" y="0" width="10" height="10"/>
	  <circle class="islandsand" id="3" cx="5" cy="5" r="1.5"/>
	</pattern>
  </defs>
  </svg>
   <!-- End Patterns -->

   <div class="container">
     <div class="row">
       <div class="col-xs-7">
  <p>Arrrrr me hearties, welcome to Pirate Island</p>
  <br>
  <br>
  {{gameDisplay}}
  <div id="form-messages"></div>
  <form id="pirateForm"> Moves:<br>
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" size="1" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <br>
    <br>
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <select class="form-dir" name="direction">
      <option selected disabled>&#8634;</option>
      <option value="u">&#8679;</option>
      <option value="d">&#8681;</option>
      <option value="l">&#8678;</option>
      <option value="r">&#8680;</option>
    </select>
    <input class="form-steps" type="number" min="1" name="step" value="" placeholder="0">
    <br>
    <br>
    <input class="btn btn-default" id="submit" type="submit">
  </form>
  <br>
  </div>
  <div class="col-xs-5">
    <br>
    <br>
    <h2>Level name : {{levelName}}</h2>
  <!--button class="btn btn-default" onclick="resetBoatPosition()">Reset Boat Position</button-->

  <h1><span id="pointsleft"></span> Points</h1>
  <h1>Your score: <span id="total-score-display"></span></h1>
  <br>
  <button class="btn-default round" onclick="document.getElementById('pirateAudio').pause()">&#9835;</button>
  <br>
  <br>
  <div id="completed-message"><p>Level Completed!</p><br><button class="btn btn-default" id="nextLevel" onclick="getNextLevel()">Next level</button></div>
  <br>
  <div id="scoreboard-message">
  <form id="scoreboard-form" method="post"> Enter your name for the scoreboard:<br>
    <input class="form-name" type="text" size="35" id="playersName" name="name" placeholder="Enter name...">
    <input class="btn btn-default" id="submitName" type="submit">
  <form>
  </div>


<br>
  <br>

  </div>
  </div>
  <!-- control Script for sending information to python code -->
  <script>

  var levelId = {{levelId}};
  var startX = {{startX}}; // boat position x
  var startY = {{startY}}; // boat position y
  var maxLevelNumber = {{maxLevelNumber}};
  var totalScore = {{score}}; // overall points from previous levels
  var maxX = {{maxX}};
  var maxY = {{maxY}};
  var maxXY = Math.max({{maxX}}, {{maxY}});
  setMaxSelection();
  document.getElementById("total-score-display").textContent = totalScore; //display initial Points


  /*Hide level completed and scoreboard message*/
  document.getElementById('completed-message').style.display = 'none';
  document.getElementById('scoreboard-message').style.display = 'none';

  var lvlpoints = 100; // points achievable in current level, is counted down
  document.getElementById("pointsleft").textContent = lvlpoints; //display initial Points

  var onMove = false; // tracks if the user is currently on a move, helps to lock the submission until move was displayed properly
  var levelCompleted=false;
  pointsCountdown(); // called when level starts; should later on be called from a start level button


/*fills in the maximum tinto the form*/
  function setMaxSelection(){
    fields = document.getElementsByClassName("form-steps")
    for (var i = 0; i < fields.length; i++) {
      fields[i].setAttribute("max", maxXY);
    }
  }


/*function to submit new score to the scoreboard*/
  $(function()
  {
    var form = $('#scoreboard-form');
    $(form).submit(function(event) {
      event.preventDefault();
        //var formData = $(form).serialize();
        var enteredName=document.getElementById("playersName").value;
        var endscore = (totalScore+lvlpoints);
        $.ajax({
          url: "main.py", //change this to submitScore.py
          type: "post",
          datatype:"json",
          data: {'score': endscore,'name': enteredName},
          success: function(response){
          //console.log(response.message)
          }
        })
    });
  });


/*Submits the pirate moves*/
    $(function()
    {
      var form = $('#pirateForm');
      // Get the messages div.
      var formMessages = $('#form-messages');
      $(form).submit(function(event) {
        event.preventDefault();
          if (onMove == true){
            return;
          }
          onMove=true;
          resetBoatPosition();

          var formData = $(form).serializeArray();
          var steps=[]
          var directions=[]
          $.each(formData, function(i, field){
            if(field.name==='step' & field.value.length>0){
              steps.push(parseInt(field.value));
            }
            else if(field.name==='direction' & field.value.length>0){
              directions.push(field.value);
            }
          });

          steps=JSON.stringify(steps)
          directions=JSON.stringify(directions)

          $.ajax({
            url: "validate.py",
            type: "post",
            datatype:"json",
            data: {'level':levelId,'steps': steps,'direction': directions},
            success: function(response){
            //console.log(response.message)
            console.log('actions: '+response.data['endactionarray']);
            //console.log('dir: '+response.data['direction']);
            console.log('dir: '+response.data['endaction']);
            moveObject(response.data['steps'], response.data['direction'], response.data['endaction']);
            }
          })
      });
    });


      function turn(arr){
        var elem = document.getElementById("OurShip");
        if(arr[1]==='y'){ // determine turn direction
          var degree=90*arr[0];
        }else if(arr[0]===1){
          var degree=0;
        }else{
          var degree=0;
        }
        elem.style.transform='rotate('+degree+'deg)';
        //elem.setAttribute('transform','translate(30,100)');
        //elem.setAttributeNS(null, 'transform', 'translate(30,100)');
      }

      /*Animates the end of the move path*/
      function endMove(endAction){
        //console.log(endAction);
        if (endAction==='crash'){
          //boom();
        }
        else if (endAction==='not_crash') {
          //sink();
        }
        else if (endAction==='end') {
          //console.log('here');
          reachEnd();
        }
      }


      function reachEnd(){
        levelCompleted=true;
        displayLevelCompleted();
      }

      /*Displays that the level is completed*/
      function displayLevelCompleted(){
        if(levelId===5){
          enterScoreBoard();
          return;
        }
        element = document.getElementById("completed-message");
        //TODO display level completed modal
        element.style.display = 'block';
      }

      function getNextLevel(){
        nextLevel = levelId+1;
        endscore = totalScore + lvlpoints;
        post('main.py', {"level": nextLevel, "score": endscore}, 'post'); //send as post
      }

      function enterScoreBoard(){
        element = document.getElementById("scoreboard-message");
        //TODO display Scoreboard modal
        element.style.display = 'block';
      }


      /*Recursive function; takes an array with numbers and 'x'/'y' direction strings*/
      function moveObject(steps, dirArr, endAction) {
        var endAction = endAction;
        var elem = document.getElementById("OurShip"); // get element to move
        var position = Number.parseInt(elem.getAttribute(dirArr[0]));
        var arrived = position + steps[0]; //end position
        var dir = steps[0]/Math.abs(steps[0]); //increment: -1 when negative, +1 when positive
        //turn([dir, dirArr[0]]);
        var moving = setInterval(step, 30); // call inner function within 10 milliseconds intervals
        function step() { //small
          if (position == arrived) { // check if element has arrived
            clearInterval(moving); // stop the element from moving
            dirArr.shift(); // remove first element of array
            steps.shift(); // remove second element of array
            if(dirArr.length >0 && steps.length >0){ // check if more moves left in arrays
              moveObject(steps, dirArr, endAction); // calls itself with new array
               }else{
              endMove(endAction)
              onMove=false; //not locked for next move anymore
            }
          } else {
            position+=dir*0.05; //dir increment (either +1 or -1)
            position= Math.round(position*100)/100;
            elem.setAttributeNS(null, dirArr[0], position); //change attributes
          }
        }
      }

      function enableMute() {
        document.getElementById("pirateAudio").muted = true;
      }


      function resetBoatPosition(){
          ship = document.getElementById("OurShip");
          ship.setAttributeNS(null, 'x', startX);
          ship.setAttributeNS(null, 'y', startY);
      }

      /*Count down points when level has started*/
      function pointsCountdown(){
        var timer = setInterval(function(){
          lvlpoints--;
          document.getElementById("pointsleft").textContent = lvlpoints;
          if((lvlpoints <= 0) || (levelCompleted==true))
              clearInterval(timer);
          },1000);
      }

      /*Helper function to submit data with POST*/
      function post(path, params, method) {
            method = method || "post"; // Set method to post by default if not specified.

            // The rest of this code assumes you are not using a library.
            var form = document.createElement("form");
            form.setAttribute("method", method);
            form.setAttribute("action", path);

            for(var key in params) {
                if(params.hasOwnProperty(key)) {
                    var hiddenField = document.createElement("input");
                    hiddenField.setAttribute("type", "hidden");
                    hiddenField.setAttribute("name", key);
                    hiddenField.setAttribute("value", params[key]);
                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            console.log(form)
            form.submit();
        }



  </script>

  </body>
</html>
